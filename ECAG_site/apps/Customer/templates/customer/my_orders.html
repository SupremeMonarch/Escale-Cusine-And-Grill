{% extends "customer/customer_base.html" %}

{% block title %}My Orders{% endblock %}

{% block styles %}
{{ block.super }}
<style>
    /* Highlight effect when redirected to order */
    .order-card:target {
        animation: highlight-fade 2s ease-out;
    }

    @keyframes highlight-fade {
        0%, 50% {
            background-color:#fff7ed; /* orange-50 */
            border-color: #f54900;; /* orange-600 */
            box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.1);
        }
        100% {
            background-color: white;
            border-color: #e5e7eb;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        }
    }

    /* Modal Backdrop */
    .modal-backdrop {
        background-color: rgba(0, 0, 0, 0.5);
        /*backdrop-filter: blur(4px);*/
    }

    /* Modal Animation */
    @keyframes modal-pop {
        0% { transform: scale(0.95); opacity: 0; }
        100% { transform: scale(1); opacity: 1; }
    }
    .animate-modal-pop {
        animation: modal-pop 0.2s ease-out forwards;
    }
</style>
{% endblock styles %}

{% block dashboard_content %}
    <div class="p-4 sm:p-6 lg:p-8 w-full max-w-[850px] mx-auto space-y-6">
        {% csrf_token %}

        <header class="flex justify-between items-center w-full w-full h-14 mx-auto mb-6 pl-4 pr-4 pt-4">
            <div class="flex flex-col justify-start items-start h-auto w-full sm:w-auto pl-2">
                <h1 class="text-xl font-bold text-gray-900">My Orders</h1>
                <p class="text-xs text-gray-600">Track and manage your food orders</p>
            </div>

            <!-- Filter Buttons -->
            <div class="flex flex-wrap gap-2 justify-start sm:justify-end truncate">
                <button class="filter-button flex justify-center items-center h-9 px-4 py-2 rounded-lg text-sm font-medium transition duration-150 ease-in-out shadow-sm border" data-status="All" >All</button>
                <button class="filter-button flex justify-center items-center h-9 px-4 py-2 rounded-lg text-sm font-medium transition duration-150 ease-in-out shadow-sm border" data-status="Pending" >Pending</button>
                <button class="filter-button flex justify-center items-center h-9 px-4 py-2 rounded-lg text-sm font-medium transition duration-150 ease-in-out shadow-sm border" data-status="Preparing" >Preparing</button>
                <button class="filter-button flex justify-center items-center h-9 px-4 py-2 rounded-lg text-sm font-medium transition duration-150 ease-in-out shadow-sm border" data-status="Completed" >Completed</button>
                <button class="filter-button flex justify-center items-center h-9 px-4 py-2 rounded-lg text-sm font-medium transition duration-150 ease-in-out shadow-sm border" data-status="Cancelled" >Cancelled</button>
            </div>
        </header>

        <!-- Orders List Container -->
        <div class="space-y-6" id="orders-list">
            {% for order in orders %}
            <div id="order-{{ order.order_id_str }}"
                 class="order-card flex flex-col w-full max-w-full p-6 rounded-xl bg-white border border-gray-200 shadow-sm scroll-mt-24 transition-colors duration-300"
                 data-status="{{ order.status }}"
                 data-order-id="{{ order.id }}">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center pb-4 border-b border-gray-200 pl-4 pr-4 gap-2">
                    <div class="flex flex-col justify-start items-start">
                        <p class="text-base font-semibold text-gray-900">#{{ order.order_id_str }}</p>
                        <p class="text-sm text-gray-500">{{ order.order_date|date:"F d, Y \a\t g:i A" }}</p>
                    </div>
                    <div class="flex flex-wrap gap-2 justify-start sm:justify-end items-center">
                        <div class="flex justify-start items-center h-7 px-3 py-1 rounded-lg bg-gray-100"><p class="text-sm text-gray-700">{{ order.order_type }}</p></div>

                        <!-- Status Badge Container -->
                        <div class="status-badge-container">
                            {% if order.status == 'Pending' %}<div class="flex justify-start items-center h-7 px-3 py-1 rounded-lg bg-yellow-100"><p class="text-sm font-medium text-yellow-800">Pending</p></div>
                            {% elif order.status == 'Preparing' %}<div class="flex justify-start items-center h-7 px-3 py-1 rounded-lg bg-blue-100"><p class="text-sm font-medium text-blue-800">Preparing</p></div>
                            {% elif order.status == 'Completed' %}<div class="flex justify-start items-center h-7 px-3 py-1 rounded-lg bg-green-100"><p class="text-sm font-medium text-green-800">Completed</p></div>
                            {% elif order.status == 'Cancelled' %}<div class="flex justify-start items-center h-7 px-3 py-1 rounded-lg bg-red-100"><p class="text-sm font-medium text-red-800">Cancelled</p></div>
                            {% else %}<div class="flex justify-start items-center h-7 px-3 py-1 rounded-lg bg-gray-100"><p class="text-sm font-medium text-gray-800">{{ order.status }}</p></div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                <div class="flex flex-col pt-4">

                    <div class="flex flex-col space-y-2 max-h-40 overflow-y-auto">
                        {% for item in order.items.all %}
                            <div class="flex justify-between items-center px-6">
                                <p class="text-sm text-left text-gray-700">{{ item.quantity }}x {{ item.item.name }}</p>
                                <p class="text-sm font-medium text-left text-gray-900">Rs {{ item.get_cost|floatformat:2 }}</p>
                            </div>
                        {% endfor %}
                    </div>
                </div>
                <div class="flex flex-col sm:flex-row justify-between items-center pt-4 border-t border-gray-200 mt-4 space-y-3 sm:space-y-0">
                    <div class="flex gap-3 w-full sm:w-auto action-buttons">
                        {% if order.status == 'Pending' %}
                        <!-- Cancel Button to trigger modal -->
                        <button onclick="openCancelModal('{{ order.id }}', '{{ order.order_id_str }}')"
                                class="cancel-btn flex justify-center items-center h-10 px-4 py-2 rounded-lg bg-red-600 text-base text-white hover:bg-red-700 transition">
                            Cancel Order
                        </button>
                        {% endif %}
                    </div>
                    <p class="text-lg font-bold text-gray-900">Rs {{ order.get_total_cost|floatformat:2 }}</p>
                </div>
            </div>

            {% endfor %}

            <!-- Message when filter returns no results -->
            <div id="no-orders-message" class="hidden text-center text-gray-500 py-10">
                <p>No orders</p>
            </div>
        </div>
    </div>

    <!-- CONFIRMATION MODAL -->
    <div id="cancel-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center modal-backdrop">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm mx-4 transform transition-all animate-modal-pop">
            <div class="text-center">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100 mb-4">
                    <svg class="h-6 w-6 text-red-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                    </svg>
                </div>
                <h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title">Cancel Order?</h3>
                <div class="mt-2">
                    <p class="text-sm text-gray-500">
                        Are you sure you want to cancel Order #<span id="modal-order-str"></span>? This action cannot be undone.
                    </p>
                </div>
            </div>
            <div class="mt-5 sm:mt-6 flex gap-3">
                <button type="button" onclick="closeCancelModal()"
                    class="flex-1 justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none sm:text-sm">
                    No, Keep Order
                </button>
                <button type="button" onclick="confirmCancelOrder()"
                    class="flex-1 justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-red-600 text-base font-medium text-white hover:bg-red-700 focus:outline-none sm:text-sm">
                    Yes, Cancel
                </button>
            </div>
        </div>
    </div>
{% endblock dashboard_content %}


{% block scripts %}
<script>
    // Variables to track the order being cancelled
    let orderToCancelId = null;
    let orderToCancelStr = null;

    document.addEventListener('DOMContentLoaded', function () {
        const buttons = document.querySelectorAll(".filter-button");
        const cards = document.querySelectorAll(".order-card");
        const noOrdersMessage = document.getElementById("no-orders-message");

        const styles = {
            inactive: ["bg-gray-100", "text-gray-600", "hover:bg-gray-200"],
            All: ["bg-gray-900", "text-white", "hover:bg-gray-700"],
            Pending: ["bg-yellow-100", "text-yellow-800", "hover:bg-yellow-200"],
            Preparing: ["bg-blue-100", "text-blue-800", "hover:bg-blue-200"],
            Completed: ["bg-green-100", "text-green-800", "hover:bg-green-200"],
            Cancelled: ["bg-red-100", "text-red-800", "hover:bg-red-200"],
        };

        function filterOrders(status) {
            let visibleCount = 0;

            // Update button styles
            buttons.forEach(button => {
                const buttonStatus = button.getAttribute("data-status");
                // Reset all styles first
                Object.values(styles).flat().forEach(styleClass => button.classList.remove(styleClass));

                if (buttonStatus === status) {
                    button.classList.add(...styles[buttonStatus]);
                } else {
                    button.classList.add(...styles.inactive);
                }
            });

            // Filter cards
            cards.forEach(card => {
                const cardStatus = card.getAttribute("data-status");
                if (status === "All" || cardStatus === status) {
                    card.style.display = "flex";
                    visibleCount++;
                } else {
                    card.style.display = "none";
                }
            });

            // Show or hide the "no orders" message
            if (visibleCount === 0) {
                noOrdersMessage.style.display = "block";
            } else {
                noOrdersMessage.style.display = "none";
            }
        }

        // Attach click event listeners
        buttons.forEach(button => {
            button.addEventListener("click", () => {
                const status = button.getAttribute("data-status");
                filterOrders(status);
            });
        });

        // Initialize filter on load
        filterOrders('All');
    });

    // --- Modal Functions ---
    // Helper to determine scrollbar width to prevent layout shift when modal is opened
    function getScrollbarWidth() {
        return window.innerWidth - document.documentElement.clientWidth;
    }

    function openCancelModal(orderId, orderIdStr) {
        orderToCancelId = orderId;
        orderToCancelStr = orderIdStr;

        document.getElementById('modal-order-str').textContent = orderIdStr;
        const modal = document.getElementById('cancel-modal');

        // Add padding to body to replace scrollbar width to prevent content jump
        const scrollbarWidth = getScrollbarWidth();
        if (scrollbarWidth > 0) {
            document.body.style.paddingRight = `${scrollbarWidth}px`;
        }

        modal.classList.remove('hidden');
        document.body.style.overflow = 'hidden'; // Prevent scrolling
    }

    function closeCancelModal() {
        orderToCancelId = null;
        orderToCancelStr = null;

        const modal = document.getElementById('cancel-modal');
        modal.classList.add('hidden');
        document.body.style.overflow = ''; // Restore scrolling
        document.body.style.paddingRight = ''; // Restore padding
    }

    async function confirmCancelOrder() {
        if (!orderToCancelId) return;

        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

        try {
            const response = await fetch(`/staff/orders/update-status/${orderToCancelId}/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({ status: 'Cancelled' })
            });

            const data = await response.json();

            if (data.success) {
                // 1. Update UI
                updateOrderCardCancelled(orderToCancelStr);
                // 2. Close Modal
                closeCancelModal();
            } else {
                alert('Failed to cancel order: ' + (data.error || 'Unknown error'));
                closeCancelModal();
            }
        } catch (error) {
            console.error('Error cancelling order:', error);
            alert('An error occurred. Please try again.');
            closeCancelModal();
        }
    }

    function updateOrderCardCancelled(orderStr) {
        // Use querySelector to find by ID since we added IDs to cards
        const card = document.getElementById(`order-${orderStr}`);
        if (!card) return;

        // Update data status for filtering
        card.setAttribute('data-status', 'Cancelled');

        // Update Badge
        const badgeContainer = card.querySelector('.status-badge-container');
        if (badgeContainer) {
            badgeContainer.innerHTML = `<div class="flex justify-start items-center h-7 px-3 py-1 rounded-lg bg-red-100"><p class="text-sm font-medium text-red-800">Cancelled</p></div>`;
        }

        // Remove the Cancel Button
        const actionButtons = card.querySelector('.action-buttons');
        if (actionButtons) {
            actionButtons.innerHTML = ''; // clear buttons
        }
    }

    // Close modal on Escape key
    document.addEventListener('keydown', function(event) {
        if (event.key === "Escape") {
            closeCancelModal();
        }
    });
</script>
{% endblock scripts %}
