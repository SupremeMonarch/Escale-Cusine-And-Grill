{% extends "admin_panel/base_dashboard.html" %}
{% load static %}

{% block dashboard_content %}
<div class="w-full max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

  <!-- Header + search/filters -->
  <div class="flex flex-col lg:flex-row justify-between items-start gap-4 mb-6">
    <h1 class="text-2xl lg:text-3xl font-bold text-gray-900">Order Management</h1>

    <form method="get" class="flex flex-col sm:flex-row items-start sm:items-center gap-3 w-full sm:w-auto">
      <input
        name="search"
        value="{{ search_query|default:'' }}"
        placeholder="Search orders..."
        class="w-full sm:w-64 px-4 py-2 rounded-lg border text-sm focus:ring-2 focus:ring-amber-500"
      />

      <select name="status" class="px-3 py-2 rounded-lg border text-sm" onchange="this.form.submit()">
        <option value="all" {% if status_filter == None or status_filter == 'all' %}selected{% endif %}>All Statuses</option>
        <option value="pending" {% if status_filter == 'pending' %}selected{% endif %}>Pending</option>
        <option value="confirmed" {% if status_filter == 'confirmed' %}selected{% endif %}>Confirmed</option>
        <option value="preparing" {% if status_filter == 'preparing' %}selected{% endif %}>Preparing</option>
        <option value="ready" {% if status_filter == 'ready' %}selected{% endif %}>Ready</option>
        <option value="completed" {% if status_filter == 'completed' %}selected{% endif %}>Completed</option>
      </select>

      <select name="type" class="px-3 py-2 rounded-lg border text-sm" onchange="this.form.submit()">
        <option value="all" {% if type_filter == None or type_filter == 'all' %}selected{% endif %}>All Types</option>
        <option value="delivery" {% if type_filter == 'delivery' %}selected{% endif %}>Delivery</option>
        <option value="takeout" {% if type_filter == 'takeout' %}selected{% endif %}>Takeout</option>
        <option value="dine in" {% if type_filter == 'dine in' %}selected{% endif %}>Dine in</option>
      </select>

      <button type="submit" class="px-4 py-2 bg-amber-600 text-white rounded-lg text-sm hover:bg-amber-700">
        Search
      </button>
    </form>
  </div>

  <!-- Status quick buttons (mobile-friendly) -->
  <div class="flex flex-wrap gap-2 mb-4">
    <a href="?status=all" class="px-3 py-1 rounded-lg text-sm {% if status_filter == None or status_filter == 'all' %}bg-amber-100 text-amber-800 border border-amber-300{% else %}bg-gray-100 text-gray-700{% endif %}">All</a>
    <a href="?status=pending" class="px-3 py-1 rounded-lg text-sm {% if status_filter == 'pending' %}bg-amber-100 text-amber-800 border border-amber-300{% else %}bg-gray-100 text-gray-700{% endif %}">Pending</a>
    <a href="?status=confirmed" class="px-3 py-1 rounded-lg text-sm {% if status_filter == 'confirmed' %}bg-amber-100 text-amber-800 border border-amber-300{% else %}bg-gray-100 text-gray-700{% endif %}">Confirmed</a>
    <a href="?status=preparing" class="px-3 py-1 rounded-lg text-sm {% if status_filter == 'preparing' %}bg-amber-100 text-amber-800 border border-amber-300{% else %}bg-gray-100 text-gray-700{% endif %}">Preparing</a>
    <a href="?status=ready" class="px-3 py-1 rounded-lg text-sm {% if status_filter == 'ready' %}bg-amber-100 text-amber-800 border border-amber-300{% else %}bg-gray-100 text-gray-700{% endif %}">Ready</a>
    <a href="?status=completed" class="px-3 py-1 rounded-lg text-sm {% if status_filter == 'completed' %}bg-amber-100 text-amber-800 border border-amber-300{% else %}bg-gray-100 text-gray-700{% endif %}">Completed</a>
  </div>

  <!-- Desktop table / Mobile cards -->
  <div class="bg-white border border-gray-200 rounded-xl shadow-sm overflow-hidden">
    <!-- Desktop table -->
    <div class="hidden md:block">
      <table class="min-w-full text-left">
        <thead class="bg-gray-50 text-gray-600">
          <tr>
            <th class="px-6 py-3 text-xs font-medium">Order</th>
            <th class="px-6 py-3 text-xs font-medium">Customer</th>
            <th class="px-6 py-3 text-xs font-medium">Type</th>
            <th class="px-6 py-3 text-xs font-medium">Status</th>
            <th class="px-6 py-3 text-xs font-medium">Total</th>
            <th class="px-6 py-3 text-xs font-medium">Time</th>
            <th class="px-6 py-3 text-xs font-medium text-right">Actions</th>
          </tr>
        </thead>
        <tbody>
        {% for order in orders %}
          <tr class="border-t hover:bg-gray-50">
            <td class="px-6 py-4 font-medium">#ord_{{ order.id }}</td>
            <td class="px-6 py-4">
              {% if order.user %}
                <div class="font-semibold text-gray-900">{{ order.user.first_name }} {{ order.user.last_name }}</div>
                <div class="text-sm text-gray-500">{{ order.user.phone|default:"—" }}</div>
              {% else %}
                <div class="font-semibold text-gray-900 text-red-500">Guest Order</div>
                <div class="text-sm text-gray-500">No phone</div>
              {% endif %}
            </td>
            <td class="px-6 py-4 capitalize">{{ order.order_type }}</td>
            <td class="px-6 py-4">
              <span class="px-3 py-1 rounded-full text-xs font-semibold
                {% if order.status == 'pending' %} bg-yellow-100 text-yellow-800
                {% elif order.status == 'confirmed' %} bg-blue-100 text-blue-800
                {% elif order.status == 'preparing' %} bg-orange-100 text-orange-800
                {% elif order.status == 'ready' %} bg-green-100 text-green-800
                {% elif order.status == 'completed' %} bg-purple-100 text-purple-800
                {% elif order.status == 'cancelled' %} bg-red-100 text-red-800
                {% endif %}">
                {{ order.status|title }}
              </span>
            </td>
            <td class="px-6 py-4 font-semibold">Rs {{ order.total }}</td>
            <td class="px-6 py-4 text-sm text-gray-500">{{ order.order_date|date:"d M Y - H:i" }}</td>
            <td class="px-6 py-4 text-right">
              <a href="{% url 'admin-order-detail' order.id %}" class="text-blue-600 hover:underline mr-4">View</a>

              {% if order.status != 'completed' and order.status != 'cancelled' %}
                <form action="{% url 'admin-order-next-status' order.id %}" method="post" class="inline">
                  {% csrf_token %}
                  <button class="px-3 py-1 bg-amber-600 text-white text-sm rounded-lg hover:bg-amber-700">Next Status</button>
                </form>
              {% endif %}
            </td>
          </tr>
        {% empty %}
          <tr>
            <td colspan="7" class="px-6 py-8 text-center text-gray-500">No orders found.</td>
          </tr>
        {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- Mobile list -->
    <div class="md:hidden space-y-3 p-4">
      {% for order in orders %}
        <div class="border rounded-lg p-4 bg-white shadow-sm">
          <div class="flex justify-between items-start">
            <div>
              <div class="text-sm font-medium text-gray-900">#ord_{{ order.id }}</div>
              <div class="text-xs text-gray-500">{{ order.order_date|date:"d M Y - H:i" }}</div>
            </div>
            <div class="text-sm font-semibold text-amber-600">Rs {{ order.total }}</div>
          </div>

          <div class="mt-3 flex justify-between items-center">
            <div class="text-sm">
              {% if order.user %}
                <div class="font-medium text-gray-900">{{ order.user.first_name }} {{ order.user.last_name }}</div>
                <div class="text-xs text-gray-500">{{ order.user.phone|default:"—" }}</div>
              {% else %}
                <div class="font-medium text-red-500">Guest Order</div>
              {% endif %}
            </div>

            <div class="text-right">
              <div class="text-xs text-gray-500 capitalize">{{ order.order_type }}</div>
              <div class="mt-2">
                <span class="px-2 py-1 rounded-full text-xs font-semibold
                  {% if order.status == 'pending' %} bg-yellow-100 text-yellow-800
                  {% elif order.status == 'confirmed' %} bg-blue-100 text-blue-800
                  {% elif order.status == 'preparing' %} bg-orange-100 text-orange-800
                  {% elif order.status == 'ready' %} bg-green-100 text-green-800
                  {% elif order.status == 'completed' %} bg-purple-100 text-purple-800
                  {% elif order.status == 'cancelled' %} bg-red-100 text-red-800
                  {% endif %}">
                  {{ order.status|title }}
                </span>
              </div>
            </div>
          </div>

          <div class="mt-3 flex gap-3">
            <a href="{% url 'admin-order-detail' order.id %}" class="text-sm text-amber-600 font-medium">View</a>
            {% if order.status != 'completed' and order.status != 'cancelled' %}
              <form action="{% url 'admin-order-next-status' order.id %}" method="post" class="inline">
                {% csrf_token %}
                <button class="text-sm px-3 py-1 rounded bg-amber-600 text-white">Next Status</button>
              </form>
            {% endif %}
          </div>
        </div>
      {% empty %}
        <div class="text-center text-gray-500">No orders found.</div>
      {% endfor %}
    </div>
  </div>

</div>
{% endblock %}