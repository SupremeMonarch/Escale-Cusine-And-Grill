{% extends "admin_panel/base_dashboard.html" %}

{% block dashboard_content %}
<div class="p-8">
  <!-- Header -->
  <div class="mb-8">
    <h1 class="text-3xl font-bold text-gray-900">Review Management</h1>
  </div>

  <!-- Stats Cards -->
  <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
    <div class="bg-white p-6 rounded-lg shadow-md">
      <div class="flex justify-between items-start">
        <div>
          <p class="text-sm font-medium text-gray-600">Average Rating</p>
          <p class="text-3xl font-bold text-gray-900 mt-2">{{ avg_rating }}/5</p>
        </div>
        <div class="bg-yellow-100 p-3 rounded-lg">
          <svg class="w-6 h-6 text-yellow-600" fill="currentColor" viewBox="0 0 17 16">
            <path d="M8.33642 12.6L3.62828 15.24L4.68194 9.94667L0.720703 6.29334L6.08238 5.65334L8.33642 0.760006L10.5905 5.65334L15.9521 6.29334L11.9909 9.94667L13.0446 15.24L8.33642 12.6Z"/>
          </svg>
        </div>
      </div>
    </div>

    <div class="bg-white p-6 rounded-lg shadow-md">
      <div class="flex justify-between items-start">
        <div>
          <p class="text-sm font-medium text-gray-600">Total Reviews</p>
          <p class="text-3xl font-bold text-gray-900 mt-2">{{ total_reviews }}</p>
        </div>
        <div class="bg-blue-100 p-3 rounded-lg">
          <svg class="w-6 h-6 text-blue-600" fill="currentColor" viewBox="0 0 17 16">
            <path d="M4.64125 12.16L1.66699 14.4933V2.16C1.66699 1.98222 1.73146 1.82666 1.86039 1.69333C1.98932 1.56 2.14714 1.49333 2.33387 1.49333H14.3376C14.5243 1.49333 14.6822 1.56 14.8111 1.69333C14.94 1.82666 15.0045 1.98222 15.0045 2.16V11.4933C15.0045 11.68 14.94 11.84 14.8111 11.9733C14.6822 12.1067 14.5243 12.1689 14.3376 12.16H4.64125ZM4.17444 10.8267H13.6707V2.82666H3.00074V11.76L4.17444 10.8267ZM5.66824 6.16H11.0032V7.49333H5.66824V6.16Z"/>
          </svg>
        </div>
      </div>
    </div>

    <div class="bg-white p-6 rounded-lg shadow-md">
      <div class="flex justify-between items-start">
        <div>
          <p class="text-sm font-medium text-gray-600">Pending Reviews</p>
          <p class="text-3xl font-bold text-gray-900 mt-2">{{ pending_count }}</p>
        </div>
        <div class="bg-yellow-100 p-3 rounded-lg">
          <svg class="w-6 h-6 text-yellow-600" fill="currentColor" viewBox="0 0 17 16">
            <path d="M8.33574 14.6667C7.42879 14.6667 6.56185 14.4933 5.73493 14.1467C4.94357 13.8089 4.23891 13.3311 3.62094 12.7133C3.00297 12.0956 2.52504 11.3911 2.18715 10.6C1.84038 9.77334 1.66699 8.90667 1.66699 8.00001C1.66699 7.09334 1.84038 6.22667 2.18715 5.40001C2.52504 4.60889 3.00297 3.90445 3.62094 3.28667C4.23891 2.66889 4.94357 2.19112 5.73493 1.85334C6.56185 1.50667 7.42879 1.33334 8.33574 1.33334C9.24269 1.33334 10.1096 1.50667 10.9366 1.85334C11.7279 2.19112 12.4326 2.66889 13.0505 3.28667C13.6685 3.90445 14.1464 4.60889 14.4843 5.40001C14.8311 6.22667 15.0045 7.09334 15.0045 8.00001C15.0045 8.90667 14.8311 9.77334 14.4843 10.6C14.1464 11.3911 13.6685 12.0956 13.0505 12.7133C12.4326 13.3311 11.7279 13.8089 10.9366 14.1467C10.1096 14.4933 9.24269 14.6667 8.33574 14.6667ZM8.33574 13.3333C9.30493 13.3333 10.203 13.0889 11.0299 12.6C11.8302 12.1289 12.4659 11.4933 12.9372 10.6933C13.4262 9.86667 13.6707 8.96889 13.6707 8.00001C13.6707 7.03112 13.4262 6.13334 12.9372 5.30667C12.4659 4.50667 11.8302 3.87112 11.0299 3.40001C10.203 2.91112 9.30493 2.66667 8.33574 2.66667C7.36655 2.66667 6.46849 2.91112 5.64157 3.40001C4.84132 3.87112 4.20556 4.50667 3.7343 5.30667C3.24526 6.13334 3.00074 7.03112 3.00074 8.00001C3.00074 8.96889 3.24526 9.86667 3.7343 10.6933C4.20556 11.4933 4.84132 12.1289 5.64157 12.6C6.46849 13.0889 7.36655 13.3333 8.33574 13.3333ZM9.00262 8.00001H11.6701V9.33334H7.66887V4.66667H9.00262V8.00001Z"/>
          </svg>
        </div>
      </div>
    </div>

    <div class="bg-white p-6 rounded-lg shadow-md">
      <div class="flex justify-between items-start">
        <div>
          <p class="text-sm font-medium text-gray-600">Flagged Reviews</p>
          <p class="text-3xl font-bold text-gray-900 mt-2">{{ flagged_count }}</p>
        </div>
        <div class="bg-red-100 p-3 rounded-lg">
          <svg class="w-6 h-6 text-red-600" fill="currentColor" viewBox="0 0 17 16">
            <path d="M8.58927 1.66666C8.71376 1.66666 8.82935 1.7 8.93605 1.76666C9.04275 1.83333 9.12722 1.92444 9.18946 2.03999L9.66961 2.99999H13.6709C13.8576 2.99999 14.0154 3.06444 14.1443 3.19333C14.2733 3.32222 14.3377 3.47999 14.3377 3.66666V11C14.3377 11.1867 14.2733 11.3444 14.1443 11.4733C14.0154 11.6022 13.8576 11.6667 13.6709 11.6667H9.4162C9.29171 11.6667 9.17612 11.6333 9.06942 11.5667C8.96272 11.5 8.87825 11.4089 8.81601 11.2933L8.33586 10.3333H3.66773V14.3333H2.33398V1.66666H8.58927ZM8.17581 2.99999H3.66773V8.99999H9.16278L9.82966 10.3333H13.004V4.33333H8.84268L8.17581 2.99999Z"/>
          </svg>
        </div>
      </div>
    </div>
  </div>

  <!-- Filter Tabs -->
  <div class="mb-6 flex gap-2">
    <a href="?status=all" class="px-4 py-2 rounded-full text-sm font-medium {% if status_filter == 'all' %}bg-blue-100 text-blue-800{% else %}bg-gray-100 text-gray-600 hover:bg-gray-200{% endif %}">All</a>
    <a href="?status=pending" class="px-4 py-2 rounded-full text-sm font-medium {% if status_filter == 'pending' %}bg-yellow-100 text-yellow-800{% else %}bg-gray-100 text-gray-600 hover:bg-gray-200{% endif %}">Pending</a>
    <a href="?status=approved" class="px-4 py-2 rounded-full text-sm font-medium {% if status_filter == 'approved' %}bg-green-100 text-green-800{% else %}bg-gray-100 text-gray-600 hover:bg-gray-200{% endif %}">Approved</a>
    <a href="?status=flagged" class="px-4 py-2 rounded-full text-sm font-medium {% if status_filter == 'flagged' %}bg-red-100 text-red-800{% else %}bg-gray-100 text-gray-600 hover:bg-gray-200{% endif %}">Flagged</a>
  </div>

  <!-- Two-Panel Layout -->
  <div class="flex gap-6">
    <!-- Left Panel: Review List -->
    <div class="w-1/3 bg-white rounded-lg shadow-md overflow-hidden border border-gray-200">
      <!-- Search -->
      <div class="p-4 border-b border-gray-200">
        <form method="get" class="relative">
          <input type="text" name="search" value="{{ search_query }}" placeholder="Search reviews..." 
                 class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-amber-600">
          <svg class="absolute left-3 top-2.5 w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-4.35-4.35m0 0A7.5 7.5 0 1010.5 18a7.5 7.5 0 006.15-3.35z"/>
          </svg>
        </form>
      </div>

      <!-- Review List -->
      <div class="h-96 overflow-y-auto">
        {% for review in reviews %}
        <div class="border-b border-gray-200 p-4 hover:bg-blue-50 cursor-pointer transition review-item" 
             onclick="selectReview({{ review.review_id }}, event)" 
             data-review-id="{{ review.review_id }}">
          <div class="flex justify-between items-start mb-2">
            <p class="font-medium text-gray-900 text-sm">{{ review.user_name }}</p>
            <span class="px-2 py-1 rounded-full text-xs font-semibold {% if review.is_verified %}bg-green-100 text-green-800{% else %}bg-yellow-100 text-yellow-800{% endif %}">
              {% if review.is_verified %}Verified{% else %}Pending{% endif %}
            </span>
          </div>

          <div class="flex gap-1 mb-2">
            {% for i in "12345" %}
              <svg class="w-3.5 h-3.5 {% if i|add:0 <= review.rating %}text-yellow-400 fill-current{% else %}text-gray-300 fill-current{% endif %}" viewBox="0 0 17 16">
                <path d="M8.3283 12.6L3.62458 15.24L4.67725 9.94666L0.719727 6.29332L6.07638 5.65332L8.3283 0.759991L10.5802 5.65332L15.9369 6.29332L11.9794 9.94666L13.032 15.24L8.3283 12.6Z"/>
              </svg>
            {% endfor %}
          </div>

          <p class="text-gray-600 text-sm mb-2 truncate">{{ review.review_text|truncatewords:15 }}</p>
          <p class="text-gray-400 text-xs">{{ review.submission_date|date:"M d, Y" }}</p>
        </div>
        {% empty %}
        <div class="p-8 text-center text-gray-500">
          <p>No reviews found</p>
        </div>
        {% endfor %}
      </div>
    </div>

    <!-- Right Panel: Review Details -->
    <div class="w-2/3 bg-white rounded-lg shadow-md p-6 border border-gray-200">
      <div id="review-detail">
        <div class="text-center text-gray-500 py-12">
          <p>Select a review to view details</p>
        </div>
      </div>
    </div>
  </div>
</div>


<script>
function selectReview(reviewId, event) {
  // Remove active state from all items
  document.querySelectorAll('.review-item').forEach(item => {
    item.classList.remove('bg-blue-50');
  });
  
  // Add active state to clicked item
  event.currentTarget.classList.add('bg-blue-50');
  
  // Fetch review details
  fetch(`/admin_panel/review-detail/${reviewId}/`)
    .then(response => response.json())
    .then(data => {
      displayReviewDetail(data);
    })
    .catch(error => console.error('Error:', error));
}

function displayReviewDetail(review) {
  const detailDiv = document.getElementById('review-detail');
  
  const starsHtml = Array.from({length: 5}, (_, i) => `
    <svg class="w-4 h-4 ${i + 1 <= review.rating ? 'text-yellow-400 fill-current' : 'text-gray-300 fill-current'}" viewBox="0 0 17 16">
      <path d="M8.3283 12.6L3.62458 15.24L4.67725 9.94666L0.719727 6.29332L6.07638 5.65332L8.3283 0.759991L10.5802 5.65332L15.9369 6.29332L11.9794 9.94666L13.032 15.24L8.3283 12.6Z"/>
    </svg>
  `).join('');

  const statusColor = review.is_verified ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800';
  const statusText = review.is_verified ? 'Verified' : 'Pending';

  detailDiv.innerHTML = `
    <div class="pb-6 border-b border-gray-200 mb-6">
      <div class="flex justify-between items-start mb-4">
        <div>
          <h2 class="text-2xl font-bold text-gray-900 mb-2">${review.review_title}</h2>
          <div class="flex items-center gap-3">
            <div class="flex gap-1">${starsHtml}</div>
            <span class="text-sm text-gray-600">by ${review.user_name}</span>
          </div>
        </div>
        <span class="px-3 py-1 rounded-full text-xs font-semibold ${statusColor}">
          ${statusText}
        </span>
      </div>
    </div>

    <div class="mb-6">
      <h3 class="text-base font-semibold text-gray-900 mb-3">Review</h3>
      <p class="text-gray-700 leading-relaxed">${review.review_text}</p>
    </div>

    <div class="grid grid-cols-2 gap-6 mb-6">
      <div>
        <h4 class="font-semibold text-gray-900 mb-3">Customer Info</h4>
        <div class="space-y-2 text-sm">
          <p class="text-gray-600"><strong>Email:</strong> ${review.email}</p>
          <p class="text-gray-600"><strong>Date:</strong> ${new Date(review.submission_date).toLocaleDateString()}</p>
          <p class="text-gray-600"><strong>Recommendation:</strong> ${review.would_recommend.charAt(0).toUpperCase() + review.would_recommend.slice(1)}</p>
        </div>
      </div>
      <div>
        <h4 class="font-semibold text-gray-900 mb-3">Order Details</h4>
        <div class="space-y-2 text-sm">
          ${review.dishes_ordered ? `<p class="text-gray-600"><strong>Dishes:</strong> ${review.dishes_ordered}</p>` : ''}
          ${review.helpful_votes ? `<p class="text-gray-600"><strong>Helpful Votes:</strong> ${review.helpful_votes}</p>` : ''}
        </div>
      </div>
    </div>

    <div class="border-t border-gray-200 pt-6">
      <h4 class="font-semibold text-gray-900 mb-4">Actions</h4>
      <div class="flex gap-3">
        ${!review.is_verified ? `
          <form method="post" style="display:inline;">
            <input type="hidden" name="csrfmiddlewaretoken" value="${document.querySelector('[name=csrfmiddlewaretoken]')?.value || ''}">
            <input type="hidden" name="review_id" value="${review.review_id}">
            <input type="hidden" name="action" value="verify">
            <button type="submit" class="px-4 py-2 rounded-lg bg-green-600 text-white text-sm font-medium hover:bg-green-700">
              Verify Review
            </button>
          </form>
        ` : ''}
        
        <button onclick="openEmailModal(${review.review_id}, '${review.email}', '${review.user_name}')" 
                class="px-4 py-2 rounded-lg bg-blue-600 text-white text-sm font-medium hover:bg-blue-700">
          Email Response
        </button>
        
        <form method="post" style="display:inline;" onsubmit="return confirm('Delete this review?');">
          <input type="hidden" name="csrfmiddlewaretoken" value="${document.querySelector('[name=csrfmiddlewaretoken]')?.value || ''}">
          <input type="hidden" name="review_id" value="${review.review_id}">
          <input type="hidden" name="action" value="delete">
          <button type="submit" class="px-4 py-2 rounded-lg bg-red-600 text-white text-sm font-medium hover:bg-red-700">
            Delete
          </button>
        </form>
      </div>
    </div>
  `;
}

function openEmailModal(reviewId, email, name) {
  const modal = document.createElement('div');
  modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
  modal.innerHTML = `
    <div class="bg-white rounded-lg p-8 max-w-md w-full">
      <h3 class="text-xl font-bold text-gray-900 mb-4">Send Email Response</h3>
      <form method="post" onsubmit="submitEmailResponse(event, ${reviewId}, '${email}')">
        <input type="hidden" name="csrfmiddlewaretoken" value="${document.querySelector('[name=csrfmiddlewaretoken]')?.value || ''}">
        <input type="hidden" name="action" value="email_response">
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-2">To: ${email}</label>
        </div>
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-2">Subject</label>
          <input type="text" name="subject" placeholder="Re: Your Review" 
                 class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-600" required>
        </div>
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-2">Message</label>
          <textarea name="message" rows="5" placeholder="Thank you for your review..." 
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-600" required></textarea>
        </div>
        <div class="flex gap-3">
          <button type="submit" class="flex-1 px-4 py-2 rounded-lg bg-blue-600 text-white font-medium hover:bg-blue-700">
            Send
          </button>
          <button type="button" onclick="this.closest('.fixed').remove()" 
                  class="flex-1 px-4 py-2 rounded-lg bg-gray-200 text-gray-800 font-medium hover:bg-gray-300">
            Cancel
          </button>
        </div>
      </form>
    </div>
  `;
  document.body.appendChild(modal);
}

function submitEmailResponse(event, reviewId, email) {
  event.preventDefault();
  const form = event.target;
  const formData = new FormData(form);
  formData.set('review_id', reviewId);
  
  fetch('/admin_panel/reviews/', {
    method: 'POST',
    body: formData
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      alert(data.message);
      document.querySelector('.fixed').remove();
      location.reload();
    } else {
      alert('Error: ' + data.error);
    }
  })
  .catch(error => {
    console.error('Error:', error);
    alert('Error sending email');
  });
}
</script>
{% endblock %}